<?php

namespace Tests\Feature;

use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\DB;
use Tests\TestCase;

class SecurityPentestScenarioTest extends TestCase
{
    use RefreshDatabase;

    public function test_idor_attempt_on_contact_status_update_is_blocked(): void
    {
        $sender = User::factory()->create(['role' => 'manager']);
        $recipient = User::factory()->create(['role' => 'coach']);
        $attacker = User::factory()->create(['role' => 'scout']);

        $contactId = DB::table('contacts')->insertGetId([
            'from_user_id' => $sender->id,
            'to_user_id' => $recipient->id,
            'subject' => 'Private',
            'message' => 'Sensitive thread',
            'status' => 'new',
            'created_at' => now(),
            'updated_at' => now(),
        ]);

        $attackerToken = $attacker->createToken('attacker', $attacker->tokenAbilities())->plainTextToken;

        $this->withHeader('Authorization', 'Bearer '.$attackerToken)
            ->patchJson('/api/contacts/'.$contactId.'/status', ['status' => 'read'])
            ->assertStatus(403);

        $this->assertDatabaseHas('contacts', [
            'id' => $contactId,
            'status' => 'new',
        ]);
    }

    public function test_privilege_escalation_attempt_for_application_status_is_blocked(): void
    {
        $teamOwner = User::factory()->create(['role' => 'team']);
        $attacker = User::factory()->create(['role' => 'player']);

        $opportunityId = DB::table('opportunities')->insertGetId([
            'team_user_id' => $teamOwner->id,
            'title' => 'Striker Needed',
            'position' => 'FW',
            'status' => 'open',
            'created_at' => now(),
            'updated_at' => now(),
        ]);

        $applicationId = DB::table('applications')->insertGetId([
            'opportunity_id' => $opportunityId,
            'player_user_id' => $attacker->id,
            'message' => 'I want in',
            'status' => 'pending',
            'created_at' => now(),
            'updated_at' => now(),
        ]);

        $attackerToken = $attacker->createToken('attacker', $attacker->tokenAbilities())->plainTextToken;

        $this->withHeader('Authorization', 'Bearer '.$attackerToken)
            ->patchJson('/api/applications/'.$applicationId.'/status', ['status' => 'accepted'])
            ->assertStatus(403);

        $this->assertDatabaseHas('applications', [
            'id' => $applicationId,
            'status' => 'pending',
        ]);
    }

    public function test_media_delete_idor_attempt_is_blocked(): void
    {
        $owner = User::factory()->create(['role' => 'player']);
        $attacker = User::factory()->create(['role' => 'team']);

        $attackerToken = $attacker->createToken('attacker', $attacker->tokenAbilities())->plainTextToken;

        $mediaId = DB::table('media')->insertGetId([
            'user_id' => $owner->id,
            'type' => 'image',
            'url' => '/storage/media/test-owner.jpg',
            'thumb_url' => null,
            'title' => 'Owner media',
            'created_at' => now(),
            'updated_at' => now(),
        ]);

        $this->withHeader('Authorization', 'Bearer '.$attackerToken)
            ->deleteJson('/api/media/'.$mediaId)
            ->assertStatus(403);

        $this->assertDatabaseHas('media', ['id' => $mediaId, 'user_id' => $owner->id]);
    }

    public function test_malformed_payload_returns_validation_error_not_server_error(): void
    {
        $team = User::factory()->create(['role' => 'team']);
        $token = $team->createToken('team', $team->tokenAbilities())->plainTextToken;

        $invalidPayload = [
            'title' => str_repeat('x', 1000),
            'status' => 'not-allowed',
            'age_min' => -1,
            'age_max' => 200,
            'city' => str_repeat('y', 200),
        ];

        $this->withHeader('Authorization', 'Bearer '.$token)
            ->postJson('/api/opportunities', $invalidPayload)
            ->assertStatus(422);
    }
}

name: Health Monitor

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-health:
    runs-on: ubuntu-latest
    steps:
      - name: Check staging health
        run: |
          curl -fsS "${STAGING_HEALTHCHECK_URL}" > /dev/null
        env:
          STAGING_HEALTHCHECK_URL: ${{ secrets.STAGING_HEALTHCHECK_URL }}

      - name: Check production health
        run: |
          curl -fsS "${PROD_HEALTHCHECK_URL}" > /dev/null
        env:
          PROD_HEALTHCHECK_URL: ${{ secrets.PROD_HEALTHCHECK_URL }}

      - name: Notify Slack on failure
        if: failure() && secrets.ALERT_SLACK_WEBHOOK_URL != ''
        run: |
          webhook="$(echo "${ALERT_SLACK_WEBHOOK_URL}" | tr -d '\r\n')"
          if [[ ! "${webhook}" =~ ^https:// ]]; then
            echo "Skipping Slack notify: ALERT_SLACK_WEBHOOK_URL is not a valid https URL"
            exit 0
          fi

          actions_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          payload="{\"text\":\"NextScout health monitor failed. Check Actions: ${actions_url}\"}"
          curl -fsS -X POST -H "Content-type: application/json" --data "${payload}" "${webhook}"
        env:
          ALERT_SLACK_WEBHOOK_URL: ${{ secrets.ALERT_SLACK_WEBHOOK_URL }}
